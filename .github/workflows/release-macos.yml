name: release-macos

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build-macos:
    runs-on: macos-14
    timeout-minutes: 90
    defaults:
      run:
        working-directory: client
    env:
      REQUIRE_NOTARIZATION: "true"
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      APPLE_API_KEY: ${{ secrets.APPLE_API_KEY }}
      APPLE_API_KEY_B64: ${{ secrets.APPLE_API_KEY_B64 }}
      APPLE_API_KEY_PATH: ${{ secrets.APPLE_API_KEY_PATH }}
      APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
      APPLE_API_ISSUER: ${{ secrets.APPLE_API_ISSUER }}
      CSC_LINK: ${{ secrets.CSC_LINK }}
      CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
      CSC_IDENTITY_AUTO_DISCOVERY: "false"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: client/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Validate signing and notarization secrets
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${CSC_LINK:-}" || -z "${CSC_KEY_PASSWORD:-}" ]]; then
            echo "Missing macOS signing secrets: CSC_LINK / CSC_KEY_PASSWORD"
            exit 1
          fi

          has_apple_id="false"
          if [[ -n "${APPLE_ID:-}" && -n "${APPLE_APP_SPECIFIC_PASSWORD:-}" && -n "${APPLE_TEAM_ID:-}" ]]; then
            has_apple_id="true"
          fi

          has_api_key="false"
          if [[ -n "${APPLE_API_KEY_ID:-}" && -n "${APPLE_API_ISSUER:-}" ]]; then
            has_key_material="false"
            if [[ -n "${APPLE_API_KEY:-}" || -n "${APPLE_API_KEY_B64:-}" ]]; then
              has_key_material="true"
            fi
            if [[ -n "${APPLE_API_KEY_PATH:-}" && -f "${APPLE_API_KEY_PATH}" ]]; then
              has_key_material="true"
            fi
            if [[ "${has_key_material}" == "true" ]]; then
              has_api_key="true"
            fi
          fi

          if [[ "${has_apple_id}" != "true" && "${has_api_key}" != "true" ]]; then
            echo "Missing notarization credentials. Configure either:"
            echo "1) APPLE_API_KEY(_PATH/_B64) + APPLE_API_KEY_ID + APPLE_API_ISSUER"
            echo "2) APPLE_ID + APPLE_APP_SPECIFIC_PASSWORD + APPLE_TEAM_ID"
            exit 1
          fi

      - name: Build DMG (signed + notarized)
        run: npm run package:mac:signed

      - name: Verify signatures and notarization tickets
        shell: bash
        run: |
          set -euo pipefail

          apps=(
            "dist/mac/VALDEN.app"
            "dist/mac-arm64/VALDEN.app"
          )

          for app in "${apps[@]}"; do
            if [[ ! -d "${app}" ]]; then
              echo "Expected app bundle is missing: ${app}"
              exit 1
            fi

            echo "Verifying code signature: ${app}"
            codesign --verify --deep --strict --verbose=2 "${app}"

            echo "Stapling app: ${app}"
            xcrun stapler staple -v "${app}"
            xcrun stapler validate -v "${app}"

            echo "Gatekeeper assessment (exec): ${app}"
            spctl -a -vv --type exec "${app}"
          done

          shopt -s nullglob
          dmgs=(dist/*.dmg)
          if [[ ${#dmgs[@]} -eq 0 ]]; then
            echo "No DMG artifacts found in dist/"
            exit 1
          fi

          for dmg in "${dmgs[@]}"; do
            echo "Stapling DMG: ${dmg}"
            xcrun stapler staple -v "${dmg}"
            xcrun stapler validate -v "${dmg}"

            echo "Gatekeeper assessment (open): ${dmg}"
            spctl -a -vv --type open "${dmg}"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: valden-macos-dmg
          path: |
            client/dist/*.dmg
            client/dist/*.blockmap
