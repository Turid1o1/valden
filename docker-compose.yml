services:
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: valden-api
    restart: unless-stopped
    environment:
      LISTEN_ADDR: 127.0.0.1:18080
      DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@127.0.0.1:5432/${POSTGRES_DB}?sslmode=disable
      MIGRATIONS_PATH: /app/migrations
      TURN_SECRET: ${TURN_SECRET}
      TURN_REALM: ${TURN_REALM}
      TURN_URLS: ${TURN_URLS}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}
      SESSION_REQUIRE_OTP: ${SESSION_REQUIRE_OTP}
    network_mode: host

  coturn:
    image: coturn/coturn:4.6.3-r1
    container_name: valden-coturn
    restart: unless-stopped
    depends_on:
      - api
    environment:
      TURN_REALM: ${TURN_REALM}
      TURN_SECRET: ${TURN_SECRET}
      PUBLIC_IP: ${PUBLIC_IP}
    command: ["-c", "/etc/coturn/turnserver.conf"]
    network_mode: host
    volumes:
      - ./infra/coturn/turnserver.conf:/etc/coturn/turnserver.conf:ro
      - ./infra/certs:/etc/coturn/certs:ro
